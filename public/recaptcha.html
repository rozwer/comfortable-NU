<!doctype html>
<!--
-----------------------------------------------------------------
Modified by: roz
Date       : 2025-08-13
Changes    : App Checkブローカーページ（自動/手動トークン受け渡しUI）を実装
Category   : 認証・AppCheck
-----------------------------------------------------------------
-->
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>App Check Broker</title>
    <style>
      body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial; padding: 16px; }
      .box { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      input[type=text] { flex: 1; min-width: 260px; padding: 8px; }
      button { padding: 8px 12px; cursor: pointer; }
      small { color: #666; }
      .ok { color: #0a8; }
      .warn { color: #a80; }
      .err { color: #d33; }
    </style>
  </head>
  <body>
    <h3>🔐 App Check Broker</h3>
    <div id="status" class="box">初期化中...</div>
    <div id="manual" class="box" style="margin-top: 12px; display: none;">
      <div class="row" style="margin-bottom: 6px;">
        <input id="token" type="text" placeholder="appcheck_token" />
        <button id="copy">コピー</button>
      </div>
      <small>自動受け渡しに失敗した場合は、このトークンを拡張機能の「App Check テスト」欄に貼り付けてください。</small>
    </div>

    <script>
      // IMPORTANT: When deploying to Firebase Hosting, ensure this origin matches the deployed site.
      const HOSTING_ORIGIN = 'https://engaged-upgrade-460911-c4.web.app';
      const qs = new URLSearchParams(location.search);

      async function getAppCheckToken() {
        // 1) If already present in fragment (debug/retry), use it
        try {
          const hash = location.hash && location.hash.startsWith('#') ? location.hash.slice(1) : '';
          const frag = new URLSearchParams(hash);
          const fromFrag = frag.get('appcheck_token');
          if (fromFrag) return fromFrag;
        } catch {}

        // 2) Debug helper: accept ?t=... as token (optional; remove if undesired)
        const t = qs.get('t');
        if (t) return t;

        // 3) TODO: Implement real token acquisition (reCAPTCHA/App Check)
        // Example placeholder for future integration:
        // const res = await fetch('/getAppCheckToken', { credentials: 'include' });
        // if (!res.ok) throw new Error('Failed to fetch token');
        // const data = await res.json();
        // return data.token;

        throw new Error('Token source not implemented');
      }

      function deliverViaRedirect(token) {
        const redirectUri = qs.get('redirect_uri');
        if (!redirectUri) return false;
        try {
          location.replace(redirectUri + '#appcheck_token=' + encodeURIComponent(token));
          return true;
        } catch { return false; }
      }

      function deliverViaPostMessage(token) {
        if (!window.opener) return false;
        try {
          // The extension verifies event.origin === HOSTING_ORIGIN
          window.opener.postMessage({ type: 'APP_CHECK_TOKEN', token }, HOSTING_ORIGIN);
          setTimeout(() => { try { window.close(); } catch {} }, 50);
          return true;
        } catch { return false; }
      }

      function showManual(token, note) {
        document.getElementById('manual').style.display = 'block';
        const input = document.getElementById('token');
        input.value = token || '';
        const copyBtn = document.getElementById('copy');
        copyBtn.onclick = async () => {
          try { await navigator.clipboard.writeText(input.value); alert('コピーしました'); }
          catch { alert('コピーに失敗しました'); }
        };
        const s = document.getElementById('status');
        s.innerHTML = `<span class="warn">⚠️ ${note || '自動受け渡しに失敗'}</span>`;
      }

      (async () => {
        const st = document.getElementById('status');
        try {
          st.textContent = 'トークン取得中...';
          const token = await getAppCheckToken();

          // 1) Prefer redirect when launched via chrome.identity.launchWebAuthFlow
          if (deliverViaRedirect(token)) {
            st.innerHTML = '<span class="ok">✅ redirectで拡張に返しました</span>';
            return;
          }
          // 2) Fallback to opener postMessage when opened via window.open
          if (deliverViaPostMessage(token)) {
            st.innerHTML = '<span class="ok">✅ postMessageで拡張に返しました（数秒で閉じます）</span>';
            return;
          }

          // 3) Manual fallback: show token for copy-paste
          showManual(token, 'window.opener/redirect_uri がないため手動に切替');
        } catch (e) {
          st.innerHTML = `<span class="err">❌ エラー: ${e instanceof Error ? e.message : String(e)}</span>`;
          showManual('', 'トークン取得に失敗');
        }
      })();
    </script>
  </body>
  </html>

