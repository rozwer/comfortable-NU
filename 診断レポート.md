# Chromeæ‹¡å¼µæ©Ÿèƒ½ Firebase App Check çµ±åˆè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ

## æ¦‚è¦
`sakai/calendar-sync/calendar-sync` ãƒªãƒã‚¸ãƒˆãƒªã® Chrome æ‹¡å¼µæ©Ÿèƒ½ (MV3) ã¨ Firebase App Check ä»˜ã Cloud Functions `appcheckPing` ã®çµ±åˆçŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¾ã—ãŸã€‚

## ğŸ“‹ è¨ºæ–­çµæœä¸€è¦§

### âœ… æ­£å¸¸ãªè¨­å®šé …ç›®

1. **Functions å´è¨­å®š**
   - âœ… `appcheckPing` ãŒ onCall(v2) ã§å®Ÿè£…æ¸ˆã¿
   - âœ… `setGlobalOptions({ region: "asia-northeast1", enforceAppCheck: true })` è¨­å®šæ¸ˆã¿
   - âœ… é–¢æ•°ãƒ¬ãƒ™ãƒ«ã§ã‚‚ `enforceAppCheck: true` ã‚’æ˜ç¤ºçš„ã«è¨­å®š

2. **Manifest.json (MV3) åŸºæœ¬è¨­å®š**
   - âœ… `"manifest_version": 3` 
   - âœ… `"permissions": ["identity"]` è¨­å®šæ¸ˆã¿
   - âœ… `"oauth2.client_id"` ã¨ Calendar ã‚¹ã‚³ãƒ¼ãƒ—è¨­å®šæ¸ˆã¿
   - âœ… `"background.service_worker": "background.js"` è¨­å®šæ¸ˆã¿

3. **Firebase SDK å–ã‚Šè¾¼ã¿**
   - âœ… MV3 é©åˆï¼šCDN ç›´æ¥ import ãªã—ï¼ˆremote code åˆ¶ç´„ã‚’ã‚¯ãƒªã‚¢ï¼‰
   - âœ… `package.json` ã« `firebase: ^12.0.0` ä¾å­˜é–¢ä¿‚ã‚ã‚Š
   - âœ… ãƒ­ãƒ¼ã‚«ãƒ«åŒæ¢±æ–¹å¼ã‚’æ¡ç”¨

### âŒ é‡å¤§ãªå•é¡Œ

1. **App Check åˆæœŸåŒ–ã®æ¬ å¦‚**
   - âŒ æ‹¡å¼µæ©Ÿèƒ½ã‚³ãƒ¼ãƒ‰ã« `initializeAppCheck` ã®å®Ÿè£…ãŒè¦‹ã¤ã‹ã‚‰ãªã„
   - âŒ `ReCaptchaEnterpriseProvider` ã®è¨­å®šãŒå­˜åœ¨ã—ãªã„
   - âŒ App Check ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„

2. **Functions å‘¼ã³å‡ºã—å®Ÿè£…ã®æ¬ å¦‚**
   - âŒ `getFunctions(app, "asia-northeast1")` ã®ä½¿ç”¨ãŒç¢ºèªã§ããªã„
   - âŒ `httpsCallable(functions, "appcheckPing")` ã®å®Ÿè£…ãŒè¦‹ã¤ã‹ã‚‰ãªã„
   - âŒ App Check ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚ãŸ SDK çµŒç”±ã®å‘¼ã³å‡ºã—ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„

3. **Manifest.json ã®åˆ¶é™**
   - âŒ `host_permissions` ã« Functions ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„
     - å¿…è¦: `https://asia-northeast1-comfortablenu.cloudfunctions.net/*`
     - ç¾åœ¨: `https://www.googleapis.com/*` ã®ã¿

### âš ï¸ æ³¨æ„äº‹é …

1. **åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã®æ··åœ¨**
   - `/sakai/calendar-sync/calendar-sync/public/recaptcha.html` ã§åˆ¥ã® Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºèª
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: `engaged-upgrade-460911-c4` vs æƒ³å®š: `comfortablenu`
   - App Check ã‚µã‚¤ãƒˆã‚­ãƒ¼: `6Lej8qErAAAAAA5drJy1WNbKXerhXUacriV8hE4K`

2. **Current Implementation**
   - ç¾åœ¨ã¯ Google Calendar API ã®ç›´æ¥å‘¼ã³å‡ºã—ã®ã¿å®Ÿè£…
   - Firebase Functions ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„
   - App Check çµ±åˆã¯æœªå®Ÿè£…

## ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®

### Priority 1: App Check çµ±åˆã®å®Ÿè£…

```typescript
// 1. Firebase åˆæœŸåŒ– (background.js ã¾ãŸã¯ popup)
import { initializeApp } from 'firebase/app';
import { initializeAppCheck, ReCaptchaEnterpriseProvider } from 'firebase/app-check';
import { getFunctions, httpsCallable } from 'firebase/functions';

const app = initializeApp(firebaseConfig);
const appCheck = initializeAppCheck(app, {
  provider: new ReCaptchaEnterpriseProvider('YOUR_SITE_KEY'),
  isTokenAutoRefreshEnabled: true
});
const functions = getFunctions(app, 'asia-northeast1');
```

### Priority 2: Functions å‘¼ã³å‡ºã—å®Ÿè£…

```typescript
// 2. appcheckPing ã®å‘¼ã³å‡ºã—
const appcheckPingFunction = httpsCallable(functions, 'appcheckPing');
const result = await appcheckPingFunction();
```

### Priority 3: Manifest.json ã®ä¿®æ­£

```json
{
  "host_permissions": [
    "https://tact.ac.thers.ac.jp/*",
    "https://www.googleapis.com/*",
    "https://asia-northeast1-comfortablenu.cloudfunctions.net/*"
  ]
}
```

### Priority 4: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã®çµ±ä¸€

- CLAUDE.md ã®è¨­å®šã«å¾“ã„ `comfortablenu` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨
- App Check ã‚µã‚¤ãƒˆã‚­ãƒ¼ã‚’æ‹¡å¼µæ©Ÿèƒ½ç”¨ã«å†è¨­å®š
- recaptcha.html ã®è¨­å®šã‚’çµ±ä¸€

## ğŸ“ å®Ÿè£…æ–¹é‡ã®ææ¡ˆ

### Option A: Popup ã§ã®åˆæœŸåŒ–
```typescript
// popup/subsakai.tsx ã§ã® Firebase åˆæœŸåŒ–
// App Check ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ background ã«é€ä¿¡
```

### Option B: Background ã§ã®åˆæœŸåŒ–  
```typescript
// background.js ã§ã® Firebase åˆæœŸåŒ–
// App Check ã‚’ service worker ã§ç®¡ç†
```

### Option C: ä¸¡æ–¹ã§ã®åˆæœŸåŒ–åˆ¶å¾¡
```typescript
// åˆæœŸåŒ–ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ä»•çµ„ã¿
// getApps().length ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹åˆ¶å¾¡
```

## ğŸ§ª æ¤œè¨¼æ‰‹é †

1. **æ‹¡å¼µæ©Ÿèƒ½ã‚’ãƒ­ãƒ¼ãƒ‰**
   - chrome://extensions ã«ã¦ã€Œãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã€ã§èª­ã¿è¾¼ã¿

2. **App Check ç–é€šç¢ºèª**
   - æ‹¡å¼µæ©Ÿèƒ½ popup ã‹ã‚‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
   - Network ã‚¿ãƒ–ã§ Functions å‘¼ã³å‡ºã—ã‚’ç¢ºèª
   - Console ã§ App Check ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆã‚’ç¢ºèª

3. **æœŸå¾…ã™ã‚‹ãƒ­ã‚°/ã‚¢ãƒ©ãƒ¼ãƒˆ**
   ```
   App Check ãƒˆãƒ¼ã‚¯ãƒ³ç”ŸæˆæˆåŠŸ
   appcheckPing å‘¼ã³å‡ºã—æˆåŠŸ: { ok: true, uid: "...", ts: 1234567890 }
   ```

## ğŸš¨ Root Cause Analysis

**ä¸»è¦å•é¡Œã®æ ¹æœ¬åŸå› **: Chrome æ‹¡å¼µæ©Ÿèƒ½ãŒç¾åœ¨ Google Calendar API ã‚’ç›´æ¥ä½¿ç”¨ã—ã¦ãŠã‚Šã€Firebase Functions + App Check ã®çµ±åˆãŒå…¨ãå®Ÿè£…ã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã€‚ã“ã‚Œã¯è¨­è¨ˆæ®µéšã§ã® Firebase çµ±åˆã®æ¤œè¨ä¸è¶³ãŒåŸå› ã€‚

## æœ€å°ä¿®æ­£æ¡ˆ

1. **Firebase è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ **: `firebase-config.js`
2. **App Check åˆæœŸåŒ–**: `background.js` ã«è¿½åŠ  (20è¡Œ)
3. **Functions å‘¼ã³å‡ºã—**: `appcheckPing` å‘¼ã³å‡ºã—é–¢æ•°è¿½åŠ  (15è¡Œ)
4. **Manifest æ¨©é™è¿½åŠ **: `host_permissions` 1è¡Œè¿½åŠ 
5. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID çµ±ä¸€**: æ—¢å­˜ recaptcha.html ã®ä¿®æ­£

**æ¨å®šä¿®æ­£æ™‚é–“**: 2-3æ™‚é–“ï¼ˆè¨­å®šå€¤ã®æº–å‚™å«ã‚€ï¼‰