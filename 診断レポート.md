# Chrome拡張機能 Firebase App Check 統合診断レポート

## 概要
`sakai/calendar-sync/calendar-sync` リポジトリの Chrome 拡張機能 (MV3) と Firebase App Check 付き Cloud Functions `appcheckPing` の統合状態を診断しました。

## 📋 診断結果一覧

### ✅ 正常な設定項目

1. **Functions 側設定**
   - ✅ `appcheckPing` が onCall(v2) で実装済み
   - ✅ `setGlobalOptions({ region: "asia-northeast1", enforceAppCheck: true })` 設定済み
   - ✅ 関数レベルでも `enforceAppCheck: true` を明示的に設定

2. **Manifest.json (MV3) 基本設定**
   - ✅ `"manifest_version": 3` 
   - ✅ `"permissions": ["identity"]` 設定済み
   - ✅ `"oauth2.client_id"` と Calendar スコープ設定済み
   - ✅ `"background.service_worker": "background.js"` 設定済み

3. **Firebase SDK 取り込み**
   - ✅ MV3 適合：CDN 直接 import なし（remote code 制約をクリア）
   - ✅ `package.json` に `firebase: ^12.0.0` 依存関係あり
   - ✅ ローカル同梱方式を採用

### ❌ 重大な問題

1. **App Check 初期化の欠如**
   - ❌ 拡張機能コードに `initializeAppCheck` の実装が見つからない
   - ❌ `ReCaptchaEnterpriseProvider` の設定が存在しない
   - ❌ App Check トークン生成・送信ロジックが実装されていない

2. **Functions 呼び出し実装の欠如**
   - ❌ `getFunctions(app, "asia-northeast1")` の使用が確認できない
   - ❌ `httpsCallable(functions, "appcheckPing")` の実装が見つからない
   - ❌ App Check トークンを含めた SDK 経由の呼び出しコードが存在しない

3. **Manifest.json の制限**
   - ❌ `host_permissions` に Functions エンドポイントへのアクセス権限がない
     - 必要: `https://asia-northeast1-comfortablenu.cloudfunctions.net/*`
     - 現在: `https://www.googleapis.com/*` のみ

### ⚠️ 注意事項

1. **別プロジェクトとの混在**
   - `/sakai/calendar-sync/calendar-sync/public/recaptcha.html` で別の Firebase プロジェクトを確認
   - プロジェクトID: `engaged-upgrade-460911-c4` vs 想定: `comfortablenu`
   - App Check サイトキー: `6Lej8qErAAAAAA5drJy1WNbKXerhXUacriV8hE4K`

2. **Current Implementation**
   - 現在は Google Calendar API の直接呼び出しのみ実装
   - Firebase Functions は使用されていない
   - App Check 統合は未実装

## 🔧 修正が必要な項目

### Priority 1: App Check 統合の実装

```typescript
// 1. Firebase 初期化 (background.js または popup)
import { initializeApp } from 'firebase/app';
import { initializeAppCheck, ReCaptchaEnterpriseProvider } from 'firebase/app-check';
import { getFunctions, httpsCallable } from 'firebase/functions';

const app = initializeApp(firebaseConfig);
const appCheck = initializeAppCheck(app, {
  provider: new ReCaptchaEnterpriseProvider('YOUR_SITE_KEY'),
  isTokenAutoRefreshEnabled: true
});
const functions = getFunctions(app, 'asia-northeast1');
```

### Priority 2: Functions 呼び出し実装

```typescript
// 2. appcheckPing の呼び出し
const appcheckPingFunction = httpsCallable(functions, 'appcheckPing');
const result = await appcheckPingFunction();
```

### Priority 3: Manifest.json の修正

```json
{
  "host_permissions": [
    "https://tact.ac.thers.ac.jp/*",
    "https://www.googleapis.com/*",
    "https://asia-northeast1-comfortablenu.cloudfunctions.net/*"
  ]
}
```

### Priority 4: プロジェクト設定の統一

- CLAUDE.md の設定に従い `comfortablenu` プロジェクトを使用
- App Check サイトキーを拡張機能用に再設定
- recaptcha.html の設定を統一

## 📝 実装方針の提案

### Option A: Popup での初期化
```typescript
// popup/subsakai.tsx での Firebase 初期化
// App Check トークンを取得して background に送信
```

### Option B: Background での初期化  
```typescript
// background.js での Firebase 初期化
// App Check を service worker で管理
```

### Option C: 両方での初期化制御
```typescript
// 初期化の重複を避ける仕組み
// getApps().length チェックによる制御
```

## 🧪 検証手順

1. **拡張機能をロード**
   - chrome://extensions にて「デベロッパーモード」で読み込み

2. **App Check 疎通確認**
   - 拡張機能 popup からボタンクリック
   - Network タブで Functions 呼び出しを確認
   - Console で App Check トークンの生成を確認

3. **期待するログ/アラート**
   ```
   App Check トークン生成成功
   appcheckPing 呼び出し成功: { ok: true, uid: "...", ts: 1234567890 }
   ```

## 🚨 Root Cause Analysis

**主要問題の根本原因**: Chrome 拡張機能が現在 Google Calendar API を直接使用しており、Firebase Functions + App Check の統合が全く実装されていない状態。これは設計段階での Firebase 統合の検討不足が原因。

## 最小修正案

1. **Firebase 設定ファイル追加**: `firebase-config.js`
2. **App Check 初期化**: `background.js` に追加 (20行)
3. **Functions 呼び出し**: `appcheckPing` 呼び出し関数追加 (15行)
4. **Manifest 権限追加**: `host_permissions` 1行追加
5. **プロジェクト ID 統一**: 既存 recaptcha.html の修正

**推定修正時間**: 2-3時間（設定値の準備含む）